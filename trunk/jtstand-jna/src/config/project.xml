<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<project name="JNA Demo" pun="HIBERNATE" defaultHostName="DEFAULTSTATION" xmlns="http://www.jtstand.com/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.jtstand.com/ jtstand-1.0.xsd">
    <class name="Clib"><![CDATA[
        import com.sun.jna.NativeLibrary
        import com.sun.jna.Platform

        public class Clib {
          private static def libc = NativeLibrary.getInstance(Platform.isWindows() ? "msvcrt" : "c")

          def methodMissing(String name, args) {
            def method = libc.getFunction(name)
            if (method) {
                return method.invokeInt(args)
            } else {
              throw new MissingMethodException(name, getClass(), args)
            }
          }
        }
    ]]>
    </class>
    <class name="JTVisaInst"><![CDATA[
        public class JTVisaInst {
          private int sesn
        }
    ]]>
    </class>
    <class name="JTVisa"><![CDATA[
        import com.sun.jna.NativeLibrary
        import com.sun.jna.Platform
        import com.sun.jna.ptr.IntByReference
        import com.sun.jna.Native
        import com.sun.jna.Memory
        import JTVisaInst

        public class JTVisa {
          private static def libc = NativeLibrary.getInstance(Platform.isWindows() ? "visa32" : "visa32")
          private final int sesn

          public JTVisa(){
            IntByReference defaultRM = new IntByReference()
            if (0 == viOpenDefaultRM(defaultRM)) {
              sesn = defaultRM.getValue()
            } else {
              throw new IllegalStateException('Cannot open default RM')
            }
          }
          
          public def open(rsrcName){
            return open(rsrcName, 0, 0)
          }

          public def open(rsrcName, accessMode, openTimeout){
            IntByReference vi = new IntByReference()
            if (0 == viOpen(sesn, rsrcName, accessMode, openTimeout, vi)){
              String name = getAttributeString(vi.getValue(), (int)0xBFFF0001)
              if (name.equals('INSTR')){
                return new JTVisaInst(sesn:vi.getValue())
              } else {
                viClose(vi.getValue())
                throw new IllegalArgumentException("Not supported class: $name")
              }
            } else {
              throw new IllegalStateException("Cannot open: $rsrcName")
            }
          }

          public int getAttributeInt(int attr){
            return getAttributeInt(sesn, attr)
          }

          public int getAttributeInt(int inst, int attr){
            IntByReference retval = new IntByReference()
            def status = viGetAttribute(inst, attr, retval)
            if (0 == status){
              return retval.getValue()
            } else {
              throw new IllegalStateException("Error reading integer attribute of instrument: $status")
            }
          }

          public int getAttributeString(int attr){
            return getAttributeString(sesn, attr)
          }

          public String getAttributeString(int inst, int attr){
            byte[] retval = new byte[256]
            def status = viGetAttribute(inst, attr, retval)
            if (0 == status){
              return Native.toString(retval)
            } else {
              throw new IllegalStateException("Error reading string attribute of instrument: $status")
            }
          }

          def methodMissing(String name, args) {
            def method = libc.getFunction(name)
            if (method) {
                return method.invokeInt(args)
            } else {
              throw new MissingMethodException(name, getClass(), args)
            }
          }
        }
    ]]>
    </class>
    <property name="persistenceProperties"><![CDATA[
        [
        'hibernate.cache.provider_class' : 'org.hibernate.cache.NoCacheProvider',
        'hibernate.show_sql' : 'false'
        ]
        ]]>
    </property>
    <property name="PERSISTING_POLICY" value="SEQUENCE"/>
    <property name="DEBUG_ENABLED" value="true"/>
    <property name="clib" mutex="true">new Clib()</property>
    <property name="visa" mutex="true">new JTVisa()</property>
    <authentication>
        <domainUser loginName="albert_kurucz" employeeNumber="87377" domainName="AM"/>
        <localUser realName="anybody"  employeeNumber="55555" password="DA39A3EE5E6B4B0D3255BFEF95601890AFD80709" loginName="55555"/>
    </authentication>
    <product partNumber="JNA_DEMO" partRevision="1.0">
        <testType name="DEMO">
            <testSequence subversionUrl="jnaDemo.xml" revision="118"/>
        </testType>
    </product>
    <product partNumber="VISA_DEMO" partRevision="1.0">
        <testType name="DEMO">
            <testSequence subversionUrl="visaDemo.xml" revision="142"/>
        </testType>
    </product>
    <testStation hostName="DEFAULTSTATION">
        <remark>This is the configuration file for the host: 'DEFAULTSTATION'</remark>
        <property name="FIXTURE_COLUMNS" value="1"/>
        <fixture fixtureName="FX1" serialNumber="FX1">
            <property name="UUT_PORT" mutex="true" value="ASRL1::INSTR"/>
            <testType partNumber="JNA_DEMO" partRevision="1.0" name="DEMO"/>
            <testType partNumber="VISA_DEMO" partRevision="1.0" name="DEMO"/>
        </fixture>
    </testStation>
</project>
